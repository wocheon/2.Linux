# GCP Managed Instance Group 자동확장 처리 

## 자동확장 처리 - Scale-out 
- Compute Engine 서비스 에이전트를 사용하여 그룹의 인스턴스를 추가 혹은 삭제 
    - 권한을 보유한 서비스 계정을 통해 인스턴스 추가/삭제 진행 

- 자동확장 처리시 지정 가능한 신호 유형 
    - CPU 사용률 (%)
    - HTTP 부하분산 사용률 (%)
    - Cloud Pub/Sub 큐 
    - Cloud Monitoring 측정항목

- 지정한 신호를 기준으로하여 특정 메트릭을 도출하며, 해당 메트릭을 기준으로 자동확장 처리가 진행됨


- 기존 메트릭과는 별개의 기준으로 측정
    - 기존 CPU 사용률 메트릭 
        - 60초 간격으로 샘플링, 샘플링후 최대 240초 동안 데이터가 표시되지않음 
    - 자동확장 처리 메트릭 - CPU 사용률
        - 현재 인스턴스 그룹 내의 VM만 대상으로 함, 30초마다 샘플링, 샘플링 후 최대 180초 동안 데이터가 표시되지 않음 


`*샘플링 기준?`
- ex) 30초마다 샘플링, 샘플링 후 최대 180초 동안 데이터가 표시되지 않음 
    - 30초마다 데이터를 샘플링 해오지만, 이 샘플링된 데이터를 모니터링,알림 등에서 사용하는 경우 최대 180초 동안의 지연시간이 발생할 수 있음


- AutoScaler 메트릭

|측정항목|설명|수집간격|지연시간|
|:-:|-:|-:|-:|
|capacity(서비스용량)|사용률 목표에 제공 VM 수를 곱한값|30초|최대 180초|
|current_utilization(현재 자동 확장 처리 활용률)|모든 제공 VM에 대해 지정된 측정항목의 사용률 합계|30초|최대 180초
|scheduled_size|자동 확장 처리가 확장 일정에 따라 권장하는 최소 VM 수|30초|최대 180초|


### 예시 환경
- 관리형 인스턴스 그룹 설정 
    - 자동확장 처리 신호 : CPU 사용률 
        - CPU 사용률 : 60 % 
    
    - 현재 VM 수 : 10대 

    - 초기화 기간 : 60초 (기본값)

- 초기화 기간 
    - 애플리케이션이 VM 인스턴스에서 초기화하는 데 걸리는 시간
    - 자동 확장 처리는 초기화 기간 내에 있는 인스턴스의 사용 데이터를 무시

### 자동확장처리 - Scale-Out 진행 과정

1. 인스턴스 그룹 내의 VM을 대상으로 CPU 사용률을 수집하여 capacity, current_utilization 값을 도출 (30초 간격)
    - `capacity` : CPU 사용률 * 현재 VM 대수 
        - 60% * 10 = 600%
    - `current_utilization` : 현재 IG에 속한 VM의 CPU 사용률 합계 

2. current_utilization이 capacity를 넘어서는경우 인스턴스 추가 진행 
    - capacity가 current_utilization 이상으로 잡히도록 인스턴스 추가 

3. 인스턴스가 추가된 뒤 current_utilization를 재 계산
    - 이때 초기화 기간 내에 있는 인스턴스의 CPU 사용률은 포함하지않고 계산을 진행 

4. 이후 다시 모니터링 진행
    
<br>

---

<br>


## 자동확장 처리 - Scale-in 

### 수평 축소 제어
- 한번에 줄어들수있는 VM 대수를 설정하는 기능 
    - 현재 VM대수의 비율 혹은 특정 대수 만큼 설정가능 
        - Percent of VMS , Number of VMS

- 인스턴스가 줄어드는 속도를 제한하여 워크로드에 부담을 최소화 하는 기능
- 축소기간을 설정해도 축소시에는 안정화기간을 따름


### 안정화 기간
- MIG내의 부하 증가 및 감소에 따라 지속적인 VM 삭제 및 생성을 방지하기 위해 신호를 안정화하기 위해 설정된 기간

- 수평 축소를 위해 최근 10분 또는 설정된 초기화 시간 중 긴 시간 동안의 최대 부하를 기준으로 그룹의 권장 목표 크기를 계산

	- CPU 사용률 등의 자동 확장 신호는 매우 안정적이지 않으며 빠르게 변동가능

	- 안정화 기간 중 관찰된 최대 부하를 처리하기 위해 충분한 VM 용량을 유지하여 신호를 안정화

	- 부하 증가시에는 안정화 기간을 거치지않고  VM 즉시 생성

- 자동 확장 처리가 VM을 삭제해야 할 때의 수평 축소 결정에만 사용

- 수평 축소시 발생하는 지연 시간이 아닌 자동 확장에 기본 제공되는 기능

- 안정화 기간 설정
	- 기본 설정 : 10분 
	- 초기화 시간이 더 10분 이상인경우 초기화 기간과 동일하게 설정



### 예시 환경
- 관리형 인스턴스 그룹 설정 
    - 자동확장 처리 신호 : CPU 사용률 
        - CPU 사용률 : 60 %     

    - 현재 VM 수 : 10대 

    - 초기화 기간 : 60초 (기본값)
    
    - 수평축소 제어
        - 다음 이하로 수평 축소 : 3 (Number of VMS)
        - 10분 
    
- 현재 시각 17:50 분 - current_utilization : 500%

### 자동확장처리 - Scale-IN 진행 과정

1. MIG의 부하 감소 
    - 18:00분에 current_utilization 250%로 감소        

2. 자동 확장 처리가 VM을 즉시 삭제하지 않고 안정화 기간 돌입
    - 18:00분 부터 안정화 기간 시작 (10분)

3. 안정화 기간 중 필요한 모니터링 용량을 유지 


4. 안정화 기간 중 발생한 최대 부하를 처리할만큼 현재 용량이 충분한 경우 Scale-In 진행
    - 이때 수평축소 제어에 설정된 값 이상으로 Scale-in 하지 않음

    - 18:10분 최대 수평 축소 가능 값인 3대 삭제 진행 
        - capacity : 60 * 7  = 420%
        - current_utilization = 250%
    
    - 다시 안정화 기간 돌입 > 삭제를 반복하여 적절 크기를 유지 
        - 18:20 
            - capacity : 60 * 5  = 300%
            - current_utilization = 250%