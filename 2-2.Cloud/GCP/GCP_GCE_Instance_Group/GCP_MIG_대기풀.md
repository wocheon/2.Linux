# 관리형 인스턴스 그룹 (MIG) - 대기풀

## 대기풀 ?
- 관리형 인스턴스 그룹에서 제공하는 기능으로 일시 중지 혹은 중지 상태의 VM을 추가적으로 할당하는 기능임
- MIG 설정과 관계없이 원하는 대수만큼 설정 가능

- 대기풀 설정시 일시정지 혹은 중지 상태의 VM 이 MIG에 추가됨
    
    - 대기풀에 속한 VM은 MIG 최소/최대 개수 산정에 포함되지않음
    
    - 대기풀에 속한 VM은 일시정지 혹은 중지 상태이므로 외부 IP를 가질수없음
        - 기동되면 자동으로 할당됨


## 대기풀 옵션    

- 수동 모드/ 수평확장 풀 모드 제공

### 수동모드 
- 대기풀에 속한 VM을 수동으로 조정하는 옵션
    - Scale-out 발생해도 대기풀의 VM이 자동으로 기동되지않음

### 수평확장 풀 모드    
- 대기풀에 속한 VM을 재개 혹은 시작하는 방식으로 수평확장 가속화를 지원
    - 신규로 VM을 생성하는 것보다 빠르게 처리

- Scale-Out 이 발생하면 대기풀에 존재하던 VM을 기동시켜 Scale-out 목표치를 달성
    - 만약 대기풀에 존재하는 VM을 모두 기동해도 목표치에 도달하지 않으면 신규로 VM 생성을 진행
    
- 대기풀에 존재하던 VM이 기동되면 다시 대기풀에 설정된 대수 만큼 VM이 추가됨

- 대기풀에서 기동된 VM은 MIG에 속한 것으로 취급되며 Scale-in 발생시 중지 or 일시정지 되지않고 삭제처리됨
    - 대기풀에 속한 VM은 Scale-in 발생시 삭제 대상이 되지않음

    - 생성시간 순서대로 삭제되므로 가장 후순위로 삭제될것으로 보임


## 대기풀 테스트
### 테스트 환경
- MIG
    - 최소 VM 대수 : 1 
    - 최대 VM 대수 : 3 
    - 현재 동작중인 VM 대수 : 1
- 대기풀 
    - 일시정지 : 1 
    - 중지 : 1 

### 1. 최초 대기풀 설정 시
- 일시중지 상태의 VM 1대 추가
- 중지 상태의 VM 1대 추가 

- MIG 현황 : 총 3 대
    - Running : 1
    - Suspended : 1 
    - Stopped : 1 

### 2. 사용량 증가로 인해 Scale-out 발생 ( 1 > 3 )    
- 대기풀에 속해있던 일시중지 상태의 VM 이 기동
- 대기풀에 속해있던 중지 상태의 VM 이 기동

- 일시중지 상태 VM 1대 , 중지 상태 VM 1대가 추가되며 대기풀에 할당됨

- MIG 현황 : 총 5대 
    - Running : 3 
    - Suspended : 1
    - Stopped : 1 

### 3. 사용량 감소로 인해 Scale-in 발생 ( 3 > 1 )
- 현재 Running 상태인 VM을 대상으로  Scale-in 발생
    - 일시정지 혹은 중지 상태로 돌아가지 않고 삭제처리됨

- 대기풀에 존재하는 VM은 그대로 유지

- MIG 현황 : 총 3 대
    - Running : 1
    - Suspended : 1 
    - Stopped : 1 

### 4.MIG 사용중지 상태로 변경 ( 1 > 0 )
- 현재 MIG에 속한 VM 개수를 0 으로 만들기위해 현재 크기/대상 크기를 0으로 변경
- Running 상태의 VM은 삭제 처리
- 대기풀에 존재하는 VM은 그대로 유지됨

- MIG 현황 : 총 2 대
    - Running : 0
    - Suspended : 1 
    - Stopped : 1 

    
## GKE Nodepool 내부 MIG에 적용 테스트

- GKE의 Nodepool 내의 MIG
    - Nodepool 생성시 MIG가 생성되고 MIG에 속한 VM을 노드로 할당하는 구조

- Nodepool 내의 MIG에서 대기풀 옵션을 적용하여 테스트를 진행

- Nodepool 설정
    - 초기 노드 개수는 1 로 설정
    - 내부 MIG에서 수평확장 대기풀 설정 
        - 중지 : 1


### 대기풀 설정 시 노드 개수 변동 여부 확인
- 노드 개수 변동 없음

- 내부 MIG에서 대기풀을 설정시 대기풀에 속하는 VM은 노드에 포함되지않음


### 노드 개수 증가 테스트 
- 노드 개수 2로 변경요청 (증가)
- 노드 개수 증가 요청시 MIG 대기풀에 속해있던 VM이 기동되며 대기풀에 중지상태 VM 추가됨
    - 정상작동 확인
- 대기풀에 새로 추가된 VM은 노드에 할당되지않았음

### 노드 개수 감소 테스트 
- 노드개수를 2 > 1 로 감소요청 

- 대기풀에 존재하던 VM이 삭제처리됨 
    - 감소 요청한 개수 만큼 대기풀에 존재하던 VM이 삭제 처리됨
        
        - Nodepool에서는 대기풀에 속하는 VM 또한 MIG에 속하는것으로 판단하는것으로 보임 
        
        - 대기풀 개수보다 많은 대수를 삭제하면 노드까지 삭제됨을 확인
        
    - Nodepool 과 MIG 대기풀 간의 옵션 충돌이 발생하는것으로 확인

- MIG 옵션 확인 결과 기존에 설정한 대기풀 옵션이 변동하는것을 확인    
    - 중지 : 1 > 0 으로 변동됨
    
    - 옵션 값이 자동으로 변동되면서 대기풀이 다시 복구되지않았음
        - Nodepool 내부 MIG는 모두 Running 상태

### 옵션 충돌 원인 확인
- 참고 
    - [GCP 매뉴얼 - 클러스터 자동 확장 정보](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler?hl=ko&_ga=2.233741918.-1590408911.1705653502)
    
```
주의: 클러스터 노드에 Compute Engine 관리형 인스턴스 그룹 자동 확장을 사용하지 마세요.
GKE의 클러스터 자동 확장 처리는 Compute Engine 자동 확장과 구분됩니다. 
이로 인해 Compute Engine 자동 확장 처리가 GKE의 클러스터 자동 확장 처리와 충돌하게 되므로 노드 풀이 확장되거나 축소되지 않을 수 있습니다.
```